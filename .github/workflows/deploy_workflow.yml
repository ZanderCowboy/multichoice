---
name: Deploy and Release
on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
  workflow_run:
    workflows: ["Test, Analyze, Build"]
    types:
      - "completed"
    branches:
      - "main"

  # workflow_dispatch:

jobs:
  predeploy:
    name: Pre-deploy
    if: ${{ github.event.workflow_run.conclusion == 'success'}} && ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: |
          echo "${{ github.head_ref }}"
          echo "${{ github.ref == 'refs/heads/main' }}"
          echo "${{ github.ref }}"

      - name: üëÅÔ∏è Check branch validity
        if: ${{ github.head_ref }} != 'refs/heads/main'
        run: |
          echo "‚ö†Ô∏è Error: you tried to create a release from '${{ github.ref }}' branch but production releases can only be created from 'main' branch"

      - name: Job Finished
        run: echo "Predeploy Job Finished"

  deploy:
    name: Deploy Apps
    if: github.event.pull_request.draft == false && ${{ github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/_deploy-env-apps.yml
    needs: predeploy
    permissions:
      contents: write
    secrets: inherit
    with:
      web-environment-flag: "Web Prod"
      android-environment-flag: "Android Prod"
      android-package-name: "co.za.zanderkotze.multichoice"
      android-track: "alpha"
      android-release-name: "v1.0.0"
      android-deploy-status: "draft"
      windows-environment-flag: "Windows Prod"
